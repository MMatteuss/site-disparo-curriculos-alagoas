<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparo de Emails</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/disparar_emails.css') }}">
</head>
<body>
    <div class="container mt-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3><i class="bi bi-send-fill"></i> Disparo de Emails em Andamento</h3>
            </div>
            <div class="card-body">
                <div class="progress mb-4">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p id="progress-text" class="text-center mb-4">0 de 0 emails enviados (0%)</p>
                
                <button id="start-button" class="btn btn-primary w-100 mb-4">
                    <i class="bi bi-play-fill"></i> Iniciar Disparo
                </button>
                
                <h4 class="mb-3"><i class="bi bi-list-check"></i> Registro de Atividades:</h4>
                <div id="log-container" class="mb-3"></div>
                
                <div id="completion-message" class="alert alert-success d-none">
                    <h4 class="alert-heading"><i class="bi bi-check-circle-fill"></i> Processo ConcluÃ­do!</h4>
                    <p id="summary-text"></p>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('compartilhar') }}" class="btn btn-success">
                            <i class="bi bi-share-fill"></i> Compartilhar
                        </a>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="bi bi-arrow-left"></i> Voltar ao InÃ­cio
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const logContainer = document.getElementById('log-container');
    const startButton = document.getElementById('start-button');
    const completionMessage = document.getElementById('completion-message');
    const summaryText = document.getElementById('summary-text');
    
    let totalEmails = 0;
    let emailsEnviados = 0;
    let emailsComErro = 0;
    let intervaloEnvio = 30000; // padrÃ£o 30 segundos
    
    function addLog(message, type = 'info') {
        const logEntry = document.createElement('div');
        logEntry.className = `alert alert-${type} fade show`;
        logEntry.innerHTML = `
            <span class="badge bg-${type}">${new Date().toLocaleTimeString()}</span>
            ${message}
        `;
        logContainer.prepend(logEntry);
        logContainer.scrollTop = 0;
    }
    
    function updateProgress(current, total) {
        const percent = Math.round((current / total) * 100);
        progressBar.style.width = `${percent}%`;
        progressBar.setAttribute('aria-valuenow', percent);
        progressText.textContent = `${current} de ${total} emails enviados (${percent}%)`;
    }
    
    function showCompletion() {
        progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
        progressBar.classList.add('bg-success');
        
        summaryText.textContent = 
            `Total de emails: ${totalEmails} | Enviados com sucesso: ${emailsEnviados} | Com erro: ${emailsComErro}`;
        
        completionMessage.classList.remove('d-none');
        startButton.classList.add('d-none');
    }
    
    function formatTime(milliseconds) {
        const minutes = Math.floor(milliseconds / 60000);
        const seconds = Math.floor((milliseconds % 60000) / 1000);
        if (minutes > 0) {
            return `${minutes}min ${seconds}s`;
        }
        return `${seconds}s`;
    }
    
    // Iniciar o processo de disparo
    startButton.addEventListener('click', async function() {
        startButton.disabled = true;
        startButton.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Preparando...
        `;
        
        addLog('Iniciando processo de disparo...', 'info');
        
        try {
            // Obter configuraÃ§Ã£o primeiro
            try {
                const configResponse = await fetch('/api/config');
                const config = await configResponse.json();
                if (config.status === 'success') {
                    intervaloEnvio = config.intervalo;
                    addLog(`Intervalo configurado: ${formatTime(intervaloEnvio)} entre emails`, 'info');
                }
            } catch (error) {
                addLog(`Usando intervalo padrÃ£o: ${formatTime(intervaloEnvio)}`, 'warning');
            }
            
            // Obter lista de emails
            const response = await fetch('/api/disparar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'error') {
                throw new Error(data.message);
            }
            
            totalEmails = data.total;
            addLog(`Lista de vagas carregada. Total: ${data.total}`, 'success');
            updateProgress(0, totalEmails);
            
            startButton.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Enviando...
            `;
            
            // Calcular tempo estimado total
            const tempoEstimado = totalEmails > 1 ? (totalEmails - 1) * intervaloEnvio : 0;
            addLog(`Tempo estimado: ${formatTime(tempoEstimado)}`, 'info');
            
            // Enviar cada email com intervalo - CÃ“DIGO CORRIGIDO
            for (let i = 0; i < data.emails_data.length; i++) {
                const emailData = data.emails_data[i];
                const email = emailData.email;
                const vagaData = emailData.vaga_data;
                const currentIndex = i + 1;

                try {
                    const emailResponse = await fetch('/api/enviar_email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            email: email, 
                            vaga_data: vagaData 
                        })
                    });

                    const result = await emailResponse.json();

                    if (result.status === 'success') {
                        emailsEnviados++;
                        addLog(`âœ“ Enviado para: ${email} - ${vagaData['Nome da Vaga']} (${currentIndex}/${totalEmails})`, 'success');
                    } else {
                        emailsComErro++;
                        addLog(`âœ— Falha no envio para ${email}: ${result.message || 'Erro desconhecido'}`, 'danger');
                    }

                    updateProgress(currentIndex, totalEmails);

                    // Intervalo configurÃ¡vel entre emails (exceto para o Ãºltimo email)
                    if (currentIndex < totalEmails) {
                        addLog(`â° Aguardando ${formatTime(intervaloEnvio)} para prÃ³ximo envio...`, 'info');
                        await new Promise(resolve => setTimeout(resolve, intervaloEnvio));
                    }

                } catch (error) {
                    emailsComErro++;
                    addLog(`âœ— Erro ao enviar email ${currentIndex}: ${error.message}`, 'danger');
                }
            }
            
            addLog('ðŸŽ‰ Processo de disparo concluÃ­do com sucesso!', 'success');
            showCompletion();
            
        } catch (error) {
            addLog(`âœ— Erro no processo de disparo: ${error.message}`, 'danger');
            startButton.disabled = false;
            startButton.innerHTML = `<i class="bi bi-play-fill"></i> Tentar Novamente`;
        }
    });
});
    </script>
</body>
</html>